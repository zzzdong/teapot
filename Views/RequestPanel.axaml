<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewmodels="using:Teapot.ViewModels"
             xmlns:models="using:Teapot.Models"
             x:Class="Teapot.Views.RequestPanel"
             x:DataType="viewmodels:RequestPanelViewModel"
             Name="MainControl"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600">
  <ScrollViewer>
    <Grid>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- ä¸ŠåŠéƒ¨åˆ† - è¯·æ±‚æž„å»ºå™¨ -->
      <Border Grid.Row="0"
              Padding="10"
              Margin="0,0,0,10">
        <Grid ColumnDefinitions="120,*,80,80">
          <ComboBox Grid.Column="0"
                    Name="MethodComboBox"
                    Width="120"
                    ItemsSource="{Binding HttpMethodOptions}"
                    SelectedItem="{Binding Request.Method, Mode=TwoWay}"/>
          <TextBox Grid.Column="1"
                    Text="{Binding Request.Url, Mode=TwoWay}"
                    Watermark="Enter request URL"
                    Margin="10,0"/>
          <Button Grid.Column="2"
                  Name="SendButton"
                  Content="Send"
                  Command="{Binding SendRequestCommand}"
                  CommandParameter="{Binding Request}"/>
          <Button Grid.Column="3"
                  Name="SaveButton"
                  Content="Save"
                  Command="{Binding SaveToCollectionCommand}"
                  CommandParameter="{Binding Request}"/>
        </Grid>
      </Border>

      <Grid Grid.Row="1">
        <Grid.RowDefinitions>
          <RowDefinition Height="*"/>
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <TabControl Grid.Row="0" SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}">
          <TabItem Header="Headers">
            <ScrollViewer>
              <ItemsControl ItemsSource="{Binding Request.Headers}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Grid Margin="5" ColumnDefinitions="30,*,*">
                      <CheckBox Grid.Column="0" IsChecked="{Binding IsActive, Mode=TwoWay}" VerticalAlignment="Center"/>
                      <TextBox Grid.Column="1" Text="{Binding Key, Mode=TwoWay}" Watermark="Key" Margin="5,0"/>
                      <TextBox Grid.Column="2" Text="{Binding Value, Mode=TwoWay}" Watermark="Value" Margin="5,0"/>
                    </Grid>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </TabItem>

          <TabItem Header="Params">
            <ScrollViewer>
              <ItemsControl ItemsSource="{Binding Request.QueryParameters}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Grid Margin="5" ColumnDefinitions="30,*,*">
                      <CheckBox Grid.Column="0" IsChecked="{Binding IsActive, Mode=TwoWay}" VerticalAlignment="Center"/>
                      <TextBox Grid.Column="1" Text="{Binding Key, Mode=TwoWay}" Watermark="Key" Margin="5,0"/>
                      <TextBox Grid.Column="2" Text="{Binding Value, Mode=TwoWay}" Watermark="Value" Margin="5,0"/>
                    </Grid>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </TabItem>

          <TabItem Header="Body">
            <StackPanel>
              <ComboBox Name="BodyTypeComboBox"
                        ItemsSource="{Binding BodyTypes}"
                        SelectedItem="{Binding Request.BodyType, Mode=TwoWay}"/>

              <!-- JSONç¼–è¾‘å™¨ - ä»…å½“BodyTypeä¸ºjsonæ—¶æ˜¾ç¤º -->
              <Grid IsVisible="{Binding IsRequestJsonTreeVisible}" Height="200">
                <!-- ç®€å•çš„JSONæ˜¾ç¤ºï¼ŒåŽç»­å¯ä»¥ä¼˜åŒ– -->
                <TextBox Name="RequestBodyJsonTextBox"
                          Text="{Binding Request.Body, Mode=TwoWay}"
                          AcceptsReturn="True"
                          TextWrapping="Wrap"
                          FontFamily="Consolas"
                          IsReadOnly="False"/>
              </Grid>

              <!-- æ™®é€šæ–‡æœ¬æ¡† - å½“BodyTypeä¸ä¸ºjsonæ—¶æ˜¾ç¤º -->
              <TextBox Name="BodyTextBox"
                        Text="{Binding Request.Body, Mode=TwoWay}"
                        AcceptsReturn="True"
                        TextWrapping="Wrap"
                        FontFamily="Consolas"
                        IsVisible="{Binding IsRequestTextVisible}"
                        Height="200"/>
            </StackPanel>
          </TabItem>

          <TabItem Header="Pre-request Script">
            <TextBox Name="PreRequestScriptTextBox"
                      Text="{Binding SelectedPreRequestScriptCode, Mode=TwoWay}"
                      AcceptsReturn="True"
                      TextWrapping="Wrap"
                      FontFamily="Consolas"/>
          </TabItem>

          <TabItem Header="Tests">
            <TextBox Name="TestScriptTextBox"
                      Text="{Binding SelectedTestScriptCode, Mode=TwoWay}"
                      AcceptsReturn="True"
                      TextWrapping="Wrap"
                      FontFamily="Consolas"/>
          </TabItem>
        </TabControl>
        
        <!-- ä¸‹åŠéƒ¨åˆ† - å“åº”æŸ¥çœ‹å™¨ -->
        <Grid Grid.Row="1">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
          </Grid.RowDefinitions>
          
          <!-- å“åº”ä¿¡æ¯æ  -->
          <Border Grid.Row="0" 
                  Padding="10">
            <StackPanel Orientation="Horizontal">
              <TextBlock Text="{Binding CurrentResponse.StatusCode, StringFormat='{}Status: {0}'}" FontWeight="Bold" Margin="0,0,15,0"/>
              <TextBlock Text="{Binding CurrentResponse.StatusDescription}" Margin="0,0,15,0"/>
              <TextBlock Text="{Binding CurrentResponse.ResponseTime, StringFormat='â±ï¸ {0}'}" Margin="0,0,15,0"/>
              <TextBlock Text="{Binding CurrentResponse.ContentLength, StringFormat='ðŸ“¥ {0} bytes'}" />
            </StackPanel>
          </Border>
          
          <!-- å“åº”å†…å®¹ -->
          <TabControl Grid.Row="1" Margin="0,10,0,0">
            <TabItem Header="Body">
              <ScrollViewer>
                <StackPanel>
                  <!-- JSONæ–‡æœ¬æ¡† - ä»…å½“Content-Typeä¸ºjsonæ—¶æ˜¾ç¤º -->
                  <TextBox Name="ResponseBodyJsonTextBox"
                            Text="{Binding CurrentResponse.Body}"
                            IsReadOnly="True"
                            AcceptsReturn="True"
                            TextWrapping="Wrap"
                            FontFamily="Consolas"
                            IsVisible="{Binding IsResponseJsonTreeVisible}"/>
                  
                  <!-- æ™®é€šæ–‡æœ¬æ¡† - å½“Content-Typeä¸ä¸ºjsonæ—¶æ˜¾ç¤º -->
                  <TextBox Name="ResponseBodyTextBox" 
                            Text="{Binding CurrentResponse.Body}"
                            IsReadOnly="True"
                            AcceptsReturn="True"
                            TextWrapping="Wrap"
                            FontFamily="Consolas"
                            IsVisible="{Binding IsResponseTextVisible}"/>
                </StackPanel>
              </ScrollViewer>
            </TabItem>
            
            <TabItem Header="Headers">
              <ScrollViewer>
                <ItemsControl ItemsSource="{Binding CurrentResponse.Headers}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Grid Margin="5" ColumnDefinitions="*,*">
                        <TextBlock Grid.Column="0" Text="{Binding Key}" FontWeight="Bold" Margin="0,0,5,0"/>
                        <TextBlock Grid.Column="1" Text="{Binding Value}" TextWrapping="Wrap"/>
                      </Grid>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </TabItem>
            
            <TabItem Header="Cookies">
              <ScrollViewer>
                <ItemsControl ItemsSource="{Binding CurrentResponse.Cookies}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Grid Margin="5" ColumnDefinitions="*,*,*">
                        <TextBlock Grid.Column="0" Text="{Binding Name}" FontWeight="Bold" Margin="0,0,5,0"/>
                        <TextBlock Grid.Column="1" Text="{Binding Value}" TextWrapping="Wrap" Margin="0,0,5,0"/>
                        <TextBlock Grid.Column="2" Text="{Binding Domain}" TextWrapping="Wrap"/>
                      </Grid>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </TabItem>
            
            <TabItem Header="Test Results">
              <ScrollViewer>
                <ItemsControl ItemsSource="{Binding CurrentResponse.TestResults}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Grid Margin="5" ColumnDefinitions="30,*,*">
                        <CheckBox Grid.Column="0" IsChecked="{Binding Passed}" IsEnabled="False" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="1" Text="{Binding TestName}" FontWeight="Bold" Margin="5,0"/>
                        <TextBlock Grid.Column="2" Text="{Binding Message}" TextWrapping="Wrap"/>
                      </Grid>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </TabItem>
          </TabControl>
        </Grid>
      </Grid>
      
    </Grid>
  </ScrollViewer>
</UserControl>